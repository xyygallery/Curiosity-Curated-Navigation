<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„å¯¼èˆª | çº¯å‰ç«¯å•æ–‡ä»¶</title>
  <style>
    :root{
      --bg: #0b0c0f; /* dark default */
      --card: #151823;
      --text: #e9edf1;
      --muted: #9aa3b2;
      --accent: #7c9cff;
      --chip: #1f2433;
      --chip-text: #c6d0e1;
      --border: #2a2f3f;
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.3);
    }
    [data-theme="light"]{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #5b6473;
      --accent: #335dff;
      --chip: #eef2ff;
      --chip-text: #2d3a66;
      --border: #e6e8ef;
      --shadow: 0 8px 24px rgba(16,24,40,.08), 0 1px 3px rgba(16,24,40,.06);
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, "Noto Sans CJK SC", sans-serif}
    *{box-sizing:border-box}
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(to bottom,var(--bg) 70%,rgba(0,0,0,0));backdrop-filter:saturate(1.2) blur(6px);}
    .toolbar{display:flex;gap:12px;align-items:center;padding:12px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.2px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#00d1ff);box-shadow:var(--shadow)}
    .search{flex:1;display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 12px;box-shadow:var(--shadow)}
    .search input{flex:1;border:none;outline:none;background:transparent;color:var(--text);font-size:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .btn.small{padding:6px 9px;border-radius:10px;font-size:12px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--chip-text);border:1px solid var(--border);cursor:pointer}
    .chip.active{outline:2px solid var(--accent);}
    .grid{display:grid;grid-template-columns:repeat( auto-fill, minmax(240px,1fr) );gap:14px;margin-top:14px}
    .card{position:relative;display:flex;flex-direction:column;gap:6px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;min-height:120px;box-shadow:var(--shadow)}
    .card .row{display:flex;align-items:center;gap:10px}
    .card .icon{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(135deg,#1f1f3a,#0a0b12)}
    [data-theme="light"] .card .icon{background:linear-gradient(135deg,#eff2ff,#e9f7ff)}
    .title{font-weight:700}
    .desc{color:var(--muted);font-size:12px}
    .meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:auto}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;background:var(--chip);color:var(--chip-text);border:1px solid var(--border)}
    .kbar{color:var(--muted);font-size:12px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
    .pin{position:absolute;top:10px;right:10px;background:transparent;border:none;color:var(--muted);cursor:pointer}
    .pin.active{color:var(--accent)}
    .sidebar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .category{padding:6px 10px;border:1px solid var(--border);background:var(--card);border-radius:10px;cursor:pointer;color:var(--muted)}
    .category.active{color:var(--text);outline:2px solid var(--accent)}
    .section-title{margin:18px 2px 8px;font-size:13px;color:var(--muted)}
    .empty{color:var(--muted);text-align:center;padding:40px}
    .hidden{display:none}
    .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .notice{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--border);margin:8px 0}
  </style>
</head>
<body>
  <header>
    <div class="container toolbar">
      <div class="brand"><div class="logo" aria-hidden="true"></div><span>æˆ‘çš„å¯¼èˆª</span></div>
      <div class="search" role="search">
        <span>ğŸ”</span>
        <input id="searchInput" type="search" autocomplete="off" placeholder="æœç´¢ï¼ˆæ”¯æŒæ ‡é¢˜/æè¿°/ç½‘å€/æ ‡ç­¾ï¼‰â€”â€” æŒ‰ / èšç„¦ï¼ŒEnter æ‰“å¼€é¦–é¡¹" />
        <button class="btn small" id="clearBtn" title="æ¸…ç©ºæœç´¢">æ¸…ç©º</button>
      </div>
      <button class="btn" id="importBtn" title="å¯¼å…¥JSONï¼ˆæ”¯æŒæ‹–æ‹½ï¼‰">ğŸ“¥ å¯¼å…¥</button>
      <button class="btn" id="exportBtn" title="å¯¼å‡ºå½“å‰æ•°æ®ä¸ºJSON">ğŸ“¤ å¯¼å‡º</button>
      <button class="btn" id="themeBtn" title="åˆ‡æ¢æ˜æš—ï¼ˆNï¼‰">ğŸŒ“ ä¸»é¢˜</button>
    </div>
    <div class="container">
      <div class="sidebar" id="categoryBar" aria-label="åˆ†ç±»è¿‡æ»¤"></div>
      <div class="chips" id="tagBar" aria-label="æ ‡ç­¾è¿‡æ»¤"></div>
      <div class="kbar">å¿«æ·é”®ï¼š/ èšç„¦æœç´¢ Â· Esc æ¸…ç©º Â· â†‘/â†“ é€‰æ‹© Â· Enter æ‰“å¼€ Â· N ä¸»é¢˜ Â· P ç½®é¡¶</div>
      <div class="divider"></div>
    </div>
  </header>

  <main class="container" id="main">
    <div id="stats" class="notice"></div>
    <div id="grid" class="grid" aria-live="polite" aria-busy="false"></div>
    <div id="empty" class="empty hidden">æœªæ‰¾åˆ°åŒ¹é…çš„é“¾æ¥ ~ è¯•è¯•æ¢ä¸ªå…³é”®è¯æˆ–æ¸…é™¤ç­›é€‰</div>
  </main>

  <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
  <input id="fileInput" type="file" accept="application/json" class="sr" />

  <script>
  ;(() => {
    /**
     * æ•°æ®ç»“æ„è¯´æ˜ï¼š
     * item = { id, title, url, description?, category?, tags?: string[], icon?: string(emoji), pinned?: boolean }
     */

    const STORAGE_KEY = 'nav.links.v1';
    const SETTINGS_KEY = 'nav.settings.v1';

    /** ç¤ºä¾‹æ•°æ®ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„500+é“¾æ¥ï¼›ä¹Ÿå¯ä»¥ç‚¹å‡»â€œå¯¼å…¥â€åŠ è½½JSON æ–‡ä»¶ï¼‰ */
    const example = [
      { id: uid(), title: 'GitHub', url: 'https://github.com', description: 'ä»£ç æ‰˜ç®¡å¹³å°', category: 'å¼€å‘', tags: ['ä»£ç ','Git'], icon: 'ğŸ’»' },
      { id: uid(), title: 'Bilibili', url: 'https://www.bilibili.com', description: 'è§†é¢‘ç½‘ç«™', category: 'å¨±ä¹', tags: ['è§†é¢‘'], icon: 'ğŸ¬' },
      { id: uid(), title: 'Google', url: 'https://www.google.com', description: 'æœç´¢ä¸€ä¸‹', category: 'å·¥å…·', tags: ['æœç´¢'], icon: 'ğŸ”' },
      { id: uid(), title: 'ChatGPT', url: 'https://chat.openai.com', description: 'AI åŠ©æ‰‹', category: 'å·¥å…·', tags: ['AI'], icon: 'ğŸ¤–' },
    ];

    /** åŠ è½½/ä¿å­˜ */
    const settings = load(SETTINGS_KEY, { theme: 'light' });
    const links = load(STORAGE_KEY, example);
    applyTheme(settings.theme);

    // æ¸²æŸ“ UI
    const grid = $('#grid');
    const empty = $('#empty');
    const searchInput = $('#searchInput');
    const clearBtn = $('#clearBtn');
    const tagBar = $('#tagBar');
    const categoryBar = $('#categoryBar');
    const stats = $('#stats');

    let state = {
      q: new URLSearchParams(location.hash.slice(1)).get('q') || '',
      tag: new Set(),
      category: 'å…¨éƒ¨',
      kIndex: 0, // é”®ç›˜é€‰æ‹©ç´¢å¼•
    };
    searchInput.value = state.q;

    // ç”Ÿæˆæ ‡ç­¾/åˆ†ç±»
    const allTags = Array.from(new Set(links.flatMap(x => x.tags || []))).sort();
    const allCats = ['å…¨éƒ¨', ...Array.from(new Set(links.map(x => x.category || 'æœªåˆ†ç»„'))).sort()];

    renderFilters();
    render();

    // äº‹ä»¶ç»‘å®š
    searchInput.addEventListener('input', () => {
      state.q = searchInput.value.trim();
      updateHash();
      render();
    });
    clearBtn.addEventListener('click', () => { searchInput.value = ''; state.q = ''; updateHash(); render(); searchInput.focus(); });

    $('#themeBtn').addEventListener('click', toggleTheme);

    // å¯¼å…¥/å¯¼å‡º
    $('#importBtn').addEventListener('click', () => $('#fileInput').click());
    $('#fileInput').addEventListener('change', onImportFile);
    $('#exportBtn').addEventListener('click', onExport);

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput){ e.preventDefault(); searchInput.focus(); searchInput.select(); }
      if (e.key === 'Escape'){ searchInput.value=''; state.q=''; updateHash(); render(); }
      if (e.key === 'n' || e.key === 'N'){ toggleTheme(); }
      if (['ArrowDown','j','J'].includes(e.key)){ e.preventDefault(); moveSel(1); }
      if (['ArrowUp','k','K'].includes(e.key)){ e.preventDefault(); moveSel(-1); }
      if (e.key === 'Enter' && document.activeElement === searchInput){ openFirst(); }
      if (e.key.toLowerCase() === 'p'){ togglePinSelected(); }
    });

    // è¿‡æ»¤æ¡ç‚¹å‡»
    tagBar.addEventListener('click', (e) => {
      const b = e.target.closest('.chip');
      if (!b) return;
      const t = b.dataset.tag;
      if (state.tag.has(t)) state.tag.delete(t); else state.tag.add(t);
      renderFilters();
      render();
    });

    categoryBar.addEventListener('click', (e) => {
      const c = e.target.closest('.category');
      if (!c) return;
      state.category = c.dataset.cat;
      renderFilters();
      render();
    });

    function renderFilters(){
      // åˆ†ç±»
      categoryBar.innerHTML = '';
      for (const c of allCats){
        const el = h('button', {class:'category'+(state.category===c?' active':''), 'data-cat': c, title: 'æŒ‰åˆ†ç±»è¿‡æ»¤'}, c);
        categoryBar.appendChild(el);
      }
      // æ ‡ç­¾
      tagBar.innerHTML = '';
      for (const t of allTags){
        const el = h('button', {class:'chip'+(state.tag.has(t)?' active':''), 'data-tag': t, title:'ç‚¹å‡»åˆ‡æ¢æ ‡ç­¾è¿‡æ»¤'}, `#${t}`);
        tagBar.appendChild(el);
      }
    }

    function normalize(str){
      return (str||'').toLowerCase();
    }

    function scoreItem(item, qTokens){
      // ç®€å•æƒé‡ï¼šæ ‡é¢˜3xï¼Œæ ‡ç­¾2xï¼Œæè¿°1.5xï¼ŒURL1xï¼›å‘½ä¸­æ¬¡æ•°ç´¯åŠ 
      if (qTokens.length===0) return 0.1; // æ²¡æœç´¢æ—¶ç»™å¾®å°åˆ†ä»¥å‚ä¸æ’åº
      let s = 0;
      const title = normalize(item.title);
      const url = normalize(item.url);
      const desc = normalize(item.description);
      const tags = (item.tags||[]).map(normalize).join(' ');
      for (const t of qTokens){
        if (title.includes(t)) s += 3;
        if (tags.includes(t)) s += 2;
        if (desc.includes(t)) s += 1.5;
        if (url.includes(t)) s += 1;
      }
      return s;
    }

    function filterAndSort(){
      const qTokens = state.q.split(/\s+/).filter(Boolean).map(x=>x.toLowerCase());
      const cat = state.category;
      const tagSet = state.tag;
      let arr = links.filter(it => {
        if (cat !== 'å…¨éƒ¨'){
          const c = it.category || 'æœªåˆ†ç»„';
          if (c !== cat) return false;
        }
        if (tagSet.size){
          const its = new Set(it.tags||[]);
          for (const t of tagSet){ if (!its.has(t)) return false; }
        }
        if (qTokens.length){
          const s = scoreItem(it, qTokens);
          return s > 0;
        }
        return true;
      });
      // æ’åºï¼šç½®é¡¶>å¾—åˆ†>æ‹¼éŸ³/ASCIIæ ‡é¢˜
      arr = arr.map(it => ({it, s: scoreItem(it, qTokens)}))
               .sort((a,b)=> (Number(b.it.pinned)-Number(a.it.pinned)) || (b.s-a.s) || a.it.title.localeCompare(b.it.title, 'zh'))
               .map(x=>x.it);
      return arr;
    }

    function render(){
      const arr = filterAndSort();
      stats.textContent = `å…± ${links.length} ä¸ªé“¾æ¥ Â· å½“å‰æ˜¾ç¤º ${arr.length} ä¸ª`;
      if (arr.length === 0){ grid.innerHTML=''; empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      grid.innerHTML = '';
      grid.setAttribute('aria-busy','true');
      // åˆ†å—æ¸²æŸ“ï¼Œé¿å…ä¸€æ¬¡æ€§æ’å…¥500+å¡ç‰‡é€ æˆå¡é¡¿
      const chunk = 60; // æ¯å¸§æ¸²æŸ“æ•°é‡
      let i = 0;
      const renderChunk = () => {
        const frag = document.createDocumentFragment();
        for (let c=0; c<chunk && i<arr.length; c++, i++){
          frag.appendChild(card(arr[i]));
        }
        grid.appendChild(frag);
        if (i < arr.length){
          requestAnimationFrame(renderChunk);
        } else {
          grid.setAttribute('aria-busy','false');
          state.kIndex = 0;
          highlightByIndex(state.kIndex);
        }
      };
      requestAnimationFrame(renderChunk);
    }

    function card(item){
      const el = h('a', {class:'card', href:item.url, target:'_blank', rel:'noopener noreferrer', title:item.url});
      const pin = h('button', {class:'pin'+(item.pinned?' active':''), title:item.pinned?'å–æ¶ˆç½®é¡¶ (P)':'ç½®é¡¶ (P)'}, item.pinned?'ğŸ“Œ':'ğŸ“');
      pin.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); item.pinned=!item.pinned; save(STORAGE_KEY, links); render(); });

      const top = h('div', {class:'row'});
      const icon = h('div', {class:'icon'}, h('span', {}, item.icon || 'ğŸ”—'));
      const title = h('div', {class:'title'}, item.title);
      top.append(icon, title);
      const desc = h('div', {class:'desc'}, item.description || 'â€”');

      const meta = h('div', {class:'meta'});
      if (item.category) meta.appendChild(h('span', {class:'tag'}, item.category));
      (item.tags||[]).forEach(t => meta.appendChild(h('span', {class:'tag'}, `#${t}`)));

      const foot = h('div', {class:'footer'});
      const urlHost = safeHost(item.url);
      const host = h('div', {class:'desc'}, urlHost);
      const copyBtn = h('button', {class:'btn small', title:'å¤åˆ¶é“¾æ¥'}, 'å¤åˆ¶');
      copyBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); navigator.clipboard.writeText(item.url); toast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); });
      foot.append(host, copyBtn);

      el.append(pin, top, desc, meta, foot);
      return el;
    }

    function openFirst(){
      const arr = grid.querySelectorAll('.card');
      if (arr.length) arr[0].click();
    }

    function moveSel(delta){
      const cards = [...grid.querySelectorAll('.card')];
      if (!cards.length) return;
      state.kIndex = Math.max(0, Math.min(cards.length-1, state.kIndex + delta));
      highlightByIndex(state.kIndex);
    }

    function highlightByIndex(i){
      const cards = [...grid.querySelectorAll('.card')];
      cards.forEach(c => c.style.outline = '');
      const cur = cards[i];
      if (cur){
        cur.style.outline = `2px solid var(--accent)`;
        cur.scrollIntoView({ block:'nearest', behavior:'smooth' });
      }
    }

    function togglePinSelected(){
      const cards = [...grid.querySelectorAll('.card')];
      const cur = cards[state.kIndex];
      if (!cur) return;
      const title = cur.querySelector('.title')?.textContent || '';
      const item = links.find(x=>x.title===title);
      if (!item) return;
      item.pinned = !item.pinned;
      save(STORAGE_KEY, links);
      render();
    }

    // å¯¼å…¥/å¯¼å‡º
    function onImportFile(e){
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = JSON.parse(String(reader.result));
          const normalized = normalizeInput(data);
          if (!Array.isArray(normalized)) throw new Error('JSON é¡»ä¸ºæ•°ç»„');
          save(STORAGE_KEY, normalized);
          location.reload();
        }catch(err){
          alert('å¯¼å…¥å¤±è´¥ï¼š'+ err.message);
        }
      };
      reader.readAsText(file);
      // é‡ç½®
      e.target.value = '';
    }

    function onExport(){
      const blob = new Blob([JSON.stringify(links, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'nav-links.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // æ‹–æ‹½å¯¼å…¥
    document.addEventListener('dragover', e=>{ e.preventDefault(); });
    document.addEventListener('drop', e=>{
      e.preventDefault();
      const file = [...(e.dataTransfer?.files||[])][0];
      if (file && file.type === 'application/json'){
        $('#fileInput').files = e.dataTransfer.files; // å¤ç”¨å¤„ç†
        $('#fileInput').dispatchEvent(new Event('change'));
      }
    });

    // å·¥å…·å‡½æ•°
    function h(tag, attrs={}, ...children){
      const el = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs||{})){
        if (k==='class') el.className = v;
        else if (k==='style') el.style.cssText = v;
        else el.setAttribute(k, v);
      }
      for (const ch of children){
        if (ch==null) continue;
        el.appendChild(typeof ch === 'string' ? document.createTextNode(ch) : ch);
      }
      return el;
    }
    function $(sel){ return document.querySelector(sel); }
    function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }
    function load(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const data = JSON.parse(raw);
        return Array.isArray(fallback) && Array.isArray(data) ? data : (data || fallback);
      }catch{ return fallback }
    }
    function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    function safeHost(url){ try{ return new URL(url).host; }catch{ return url; } }
    function updateHash(){ const p = new URLSearchParams(); if (state.q) p.set('q',state.q); location.hash = p.toString(); }

    function toggleTheme(){
      const cur = document.documentElement.getAttribute('data-theme') || 'light';
      const next = cur === 'light' ? 'dark' : 'light';
      applyTheme(next);
      settings.theme = next; save(SETTINGS_KEY, settings);
    }
    function applyTheme(mode){ document.documentElement.setAttribute('data-theme', mode); }

    function toast(msg){
      const t = h('div', {style:'position:fixed;left:50%;bottom:30px;transform:translateX(-50%);background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;box-shadow:var(--shadow);z-index:1000'}, msg);
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 1400);
    }

    function normalizeInput(data){
      // å…¼å®¹å¤šç§å­—æ®µå‘½å
      return (data||[]).map((x,i)=>{
        const title = x.title || x.name || x.text || `æœªå‘½å ${i+1}`;
        const url = x.url || x.link || x.href || '';
        const description = x.description || x.desc || '';
        const category = x.category || x.group || x.folder || '';
        const tags = x.tags || x.labels || [];
        const icon = x.icon || '';
        const pinned = Boolean(x.pinned);
        return { id: uid(), title, url, description, category, tags, icon, pinned };
      }).filter(x=>x.url);
    }
  })();
  </script>
</body>
</html>
