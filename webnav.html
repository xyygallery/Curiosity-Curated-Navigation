<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>我的导航 · 本地版</title>
  <meta name="color-scheme" content="light dark">
  <style>
    /* ===== 设计系统 ===== */
    :root{
      --bg: #ffffff;
      --fg: #0f172a;
      --muted:#6b7280;
      --card:#f6f7fb;
      --border:#e5e7eb;
      --accent:#2563eb;
      --radius:16px;
      --shadow: 0 6px 30px rgba(0,0,0,.06);
      --ring: 0 0 0 4px color-mix(in oklab, var(--accent) 18%, transparent);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1020;
        --fg:#e5e7eb;
        --muted:#9aa2b2;
        --card:#111831;
        --border:#1d253f;
        --shadow: 0 8px 36px rgba(0,0,0,.35);
        --accent:#3b82f6;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 16px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    .wrap{max-width: 1120px; margin: 0 auto; padding: clamp(16px,4vw,32px);}

    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:34px;height:34px;border-radius:10px;background:var(--card);border:1px solid var(--border);display:grid;place-items:center;font-weight:800;letter-spacing:.5px}
    .hello{font-weight:800; font-size: clamp(20px,2.4vw,28px); letter-spacing:.2px;}

    .tools{display:flex;gap:8px;align-items:center}
    .search{position:relative;min-width:220px;}
    .search input{
      width:100%; padding:10px 12px 10px 36px; border:1px solid var(--border); border-radius:12px;
      background:var(--card); color:var(--fg); outline:none;
    }
    .search input:focus{ box-shadow: var(--ring); border-color: var(--accent) }
    .search .icon{ position:absolute; left:10px; top:50%; translate:0 -50%; opacity:.65 }

    .btn{ border:1px solid var(--border); background:transparent; color:var(--fg);
      border-radius:12px; padding:10px 12px; cursor:pointer; transition:border-color .18s ease, transform .06s ease }
    .btn:hover{ border-color: var(--accent) }
    .btn:active{ transform: translateY(1px) }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#fff }

    .groups{ display:grid; gap:16px }
    .group{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow) }
    .group-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border) }
    .group-title{ margin:0; font-size:14px; letter-spacing:.4px; text-transform:uppercase; color:var(--muted) }

    .links{ display:grid; gap:10px; padding:12px; grid-template-columns: repeat(1, minmax(0,1fr)); }
    @media (min-width: 600px){ .links{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (min-width: 900px){ .links{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (min-width: 1200px){ .links{ grid-template-columns: repeat(4, minmax(0,1fr)); } }

    .link{ display:flex; gap:10px; align-items:flex-start; padding:10px 12px; border:1px solid var(--border); border-radius:14px; background:transparent; text-decoration:none; color:var(--fg); transition: transform .06s ease, border-color .18s ease; word-break: break-word; min-height:56px }
    .link:hover{ transform: translateY(-1px); border-color: var(--accent) }
    .link .ico{ flex:0 0 28px; height:28px; width:28px; border-radius:8px; border:1px solid var(--border); background:var(--bg); display:grid; place-items:center; font-size:12px; font-weight:700 }
    .link .meta{ display:flex; flex-direction:column; gap:4px; min-width:0 }
    .link-title{ font-weight:650; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .link-desc{ font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

    dialog{ border:1px solid var(--border); border-radius:18px; max-width:min(880px,92vw); box-shadow:var(--shadow); padding:0; background:var(--bg); color:var(--fg) }
    .dlg-head{ display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid var(--border) }
    .dlg-body{ padding:12px 14px }
    .row{ display:flex; gap:10px; justify-content:flex-end; padding:0 14px 14px }
    textarea{ width:100%; min-height:300px; border:1px solid var(--border); border-radius:12px; background:var(--card); color:var(--fg); padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px }
    textarea:focus{ box-shadow:var(--ring); border-color:var(--accent) }

    .hint{ font-size:12px; color:var(--muted) }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:var(--card) }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">NV</div>
        <div class="hello" id="hello">你好</div>
      </div>
      <div class="tools">
        <div class="search" title="搜索标题/描述/分组">
          <span class="icon">🔎</span>
          <input id="q" type="search" placeholder="搜索… ( / )" autocomplete="off" />
        </div>
        <button class="btn" id="editBtn" title="编辑本地 JSON (Ctrl+E)">✏️ 编辑</button>
        <button class="btn" id="importBtn" title="导入 JSON 文件">⬆️ 导入</button>
        <button class="btn" id="exportBtn" title="导出为 JSON">⬇️ 导出</button>
      </div>
    </header>

    <main class="groups" id="groups" aria-live="polite"></main>
  </div>

  <!-- 本地 JSON 编辑器 -->
  <dialog id="editor">
    <div class="dlg-head">
      <strong>编辑链接（原始 JSON 结构）</strong>
      <button class="btn" id="closeDlg" aria-label="关闭">✖</button>
    </div>
    <div class="dlg-body">
      <textarea id="jsonArea" spellcheck="false"></textarea>
      <p class="hint">结构：<code>data → groupList → siteList</code>；字段：<code>name / url / desc</code>。保存后会持久化到 <code>localStorage</code>。</p>
      <p class="hint">快捷键：<span class="kbd">Ctrl</span>+<span class="kbd">S</span> 保存，<span class="kbd">Esc</span> 关闭。</p>
    </div>
    <div class="row">
      <button class="btn" id="resetBtn">恢复初始</button>
      <button class="btn primary" id="saveBtn">保存到本地</button>
    </div>
  </dialog>

  <input id="filePicker" type="file" accept="application/json" hidden>

  <script>
    // ===================== 初始数据（与你提供的结构保持一致） =====================
    let RAW = {
      "data":[{"id":1725801071594,"name":"网站","groupList":[
        {"id":1725801166515,"name":"分组 1","siteList":[
          {"id":1725801230597,"name":"Github","url":"https://github.com/wohccdaa/Curiosity-Curated-Navigation","favicon":"","desc":""},
          {"id":1754842556449,"name":"Telegram","url":"https://web.telegram.org/a/","favicon":"","desc":""}
        ]},
        {"id":1725801370995,"name":"分组 2 ","siteList":[
          {"id":1725801392782,"name":"Vercel","url":"https://vercel.com/wohccdaas-projects","favicon":"","desc":""},
          {"id":1725801420511,"name":"阿里域名","url":"https://dc.console.aliyun.com/next/index?spm=5176.12818093_47.overview_recent.2.3be92cc93m9IbE#/domain-list/all?type=","favicon":"","desc":""},
          {"id":1725801510569,"name":"Cloudflare","url":"https://dash.cloudflare.com/b5d549cb9c53a68240a04858b8669153/tlkk.top","favicon":"","desc":""}
        ]},
        {"id":1725801452515,"name":"分组 3","siteList":[
          {"id":1725801463245,"name":"IT 狗","url":"https://www.itdog.cn/http/","favicon":"","desc":""},
          {"id":1730015521044,"name":"W3C链接检查","url":"https://validator.w3.org/checklink","favicon":"","desc":""},
          {"id":1754842583129,"name":"风之谷 VPN","url":"https://cn1.fengzg.net/#/login","favicon":"","desc":""}
        ]},
        {"id":1725801619132,"name":"分组 4","siteList":[
          {"id":1726403456500,"name":"即刻","url":"https://web.okjike.com/","favicon":"","desc":""},
          {"id":1725801676787,"name":"有趣之家","url":"https://youquhome.com/message/","favicon":"","desc":""},
          {"id":1751297621049,"name":"科技爱好者周刊","url":"https://ruanyf.aolifu.org/","favicon":"","desc":""},
          {"id":1729604533332,"name":"偷懒周刊","url":"https://echosoar.github.io/weekly/","favicon":"","desc":""},
          {"id":1725801947812,"name":"Linuxdo","url":"https://linux.do/c/resource/14","favicon":"","desc":""},
          {"id":1729603630090,"name":"博客聚合","url":"https://www.v2ex.com/xna","favicon":"","desc":""},
          {"id":1729602527419,"name":"站长","url":"https://www.v2ex.com/go/webmaster","favicon":"","desc":""},
          {"id":1725801820129,"name":"分享创造","url":"https://www.v2ex.com/go/create","favicon":"","desc":"V2EX"},
          {"id":1726643045979,"name":"大橘周刊","url":"https://rrorangeandfriends.de/","favicon":"","desc":""},
          {"id":1725801723005,"name":"奇趣网站","url":"https://qiqu.dreamthere.cn/index/index","favicon":"","desc":""},
          {"id":1725801881657,"name":"小众软件","url":"https://meta.appinn.net/","favicon":"","desc":""}
        ]}
      ]}],
      "settings":{"linkStrategy":"newTab"}
    };

    // ===================== 工具函数 =====================
    const $ = sel => document.querySelector(sel);
    const groupsEl = $("#groups");
    const helloEl  = $("#hello");
    const qInput   = $("#q");
    const editBtn  = $("#editBtn");

    function escapeHTML(s){return String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",
      ">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
    function greet(){ const h=new Date().getHours(); helloEl.textContent = h<11?"早上好":(h<14?"中午好":"晚上好"); }

    function normalizeData(raw){
      const out = [];
      (raw?.data||[]).forEach(cat=>{
        (cat?.groupList||[]).forEach(g=>{
          out.push({
            title: g?.name ?? "未命名分组",
            links: (g?.siteList||[]).map(s=>({ t:s?.name||s?.url||"未命名", u:s?.url||"#", d:s?.desc||"" }))
          });
        });
      });
      return out;
    }

    // 生成域名首字母头像
    function toInitial(url){ try{ const u=new URL(url); const h=u.hostname.replace(/^www\./,''); return h[0]?.toUpperCase()||"·" }catch{ return "·" } }

    function faviconURL(url){
      try{
        const u = new URL(url);
        return `${u.origin}/favicon.ico`;
      }catch{ return '' }
    }

    function render(filter=""){
      const data = normalizeData(RAW);
      const kw = filter.trim().toLowerCase();
      groupsEl.innerHTML = "";

      data.forEach(group=>{
        // 过滤：匹配分组/标题/描述
        const links = group.links.filter(l=>{
          if(!kw) return true;
          return group.title.toLowerCase().includes(kw)
            || l.t.toLowerCase().includes(kw)
            || l.d.toLowerCase().includes(kw)
            || l.u.toLowerCase().includes(kw);
        });
        if(!links.length) return;

        const sec = document.createElement("section");
        sec.className = "group";
        sec.innerHTML = `<div class="group-head"><h2 class="group-title">${escapeHTML(group.title)}</h2></div><div class="links"></div>`;
        const list = sec.querySelector(".links");

        links.forEach(link=>{
          const a = document.createElement("a");
          a.className = "link"; a.href = link.u;
          if(RAW?.settings?.linkStrategy!=="sameTab"){ a.target = "_blank"; a.rel = "noopener noreferrer"; }
          a.innerHTML = `
            <div class="ico" aria-hidden="true"><img alt="" decoding="async" referrerpolicy="no-referrer" width="16" height="16" style="width:16px;height:16px" onerror="this.remove();this.parentElement.textContent='${escapeHTML(toInitial(link.u))}'" src="${escapeHTML(faviconURL(link.u))}"></div>
            <div class="meta">
              <div class="link-title" title="${escapeHTML(link.t)}">${escapeHTML(link.t)}</div>
              ${link.d?`<div class="link-desc" title="${escapeHTML(link.d)}">${escapeHTML(link.d)}</div>`:""}
            </div>`;
          list.appendChild(a);
        });
        groupsEl.appendChild(sec);
      });
      localStorage.setItem("nav.raw", JSON.stringify(RAW));
    }

    // 初次加载：若本地已有，优先用本地
    try{ const cached = JSON.parse(localStorage.getItem("nav.raw")); if (cached && cached.data) RAW = cached; }catch{}

    greet(); render(); setInterval(greet, 60*1000);

    // 搜索：快捷键 / 聚焦；输入时过滤
    window.addEventListener('keydown', (e)=>{
      if(e.key==='/' && document.activeElement!==qInput){ e.preventDefault(); qInput.focus(); }
      if(e.ctrlKey && e.key.toLowerCase()==='e'){ e.preventDefault(); editBtn.click(); }
    });
    qInput.addEventListener('input', ()=> render(qInput.value));

    // ========== 本地编辑对话框 ==========
    const dlg = document.getElementById("editor");
    const jsonArea = document.getElementById("jsonArea");
    document.getElementById("closeDlg").addEventListener("click", ()=> dlg.close());
    document.getElementById("resetBtn").addEventListener("click", ()=>{
      if(confirm("确认恢复到页面内置初始数据？这会覆盖本地自定义。")) location.reload();
    });
    document.getElementById("saveBtn").addEventListener("click", saveFromTextarea);
    document.addEventListener('keydown', (e)=>{
      if(dlg.open && e.key==='Escape') dlg.close();
      if(dlg.open && e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); saveFromTextarea(); }
    });
    function saveFromTextarea(){
      try{
        const next = JSON.parse(jsonArea.value);
        if(!Array.isArray(next?.data)) throw new Error("缺少 data 数组");
        RAW = next; render(qInput.value); dlg.close();
      }catch(e){ alert("保存失败：\n"+e.message); }
    }
    editBtn.addEventListener("click", ()=>{ jsonArea.value = JSON.stringify(RAW, null, 2); dlg.showModal(); jsonArea.focus(); });

    // ========== 纯本地导入 / 导出 ==========
    const picker = document.getElementById('filePicker');
    document.getElementById('importBtn').addEventListener('click', ()=> picker.click());
    picker.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      try{
        const text = await f.text(); const next = JSON.parse(text);
        if(!Array.isArray(next?.data)) throw new Error('JSON 结构无效：需要 data 数组');
        RAW = next; render(qInput.value);
        alert('已导入。');
      }catch(err){ alert('导入失败：\n'+err.message); }
      finally{ picker.value = ''; }
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(RAW, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'nav.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
